# Taskfile.yml

version: '3'
# ë³€ìˆ˜ ì„¤ì •
vars:
  # Subtree êµ¬ì„± ë¦¬ìŠ¤íŠ¸: [ë¦¬ëª¨íŠ¸ ì´ë¦„] [ë¡œì»¬ í´ë” ê²½ë¡œ]
  SUBTREES:
    - {remote: andromeda-remote, path: log-tutorials}
    - {remote: galaxy-remote, path: dream-manifest}
    - {remote: triangulum-remote, path: data-knowledge}
    - {remote: pegasus-remote, path: gear-utility}
  # Submodule ê²½ë¡œ (ì˜ˆì‹œ: log-tutorials ë‚´ë¶€ì˜ postgresql íŠœí† ë¦¬ì–¼)
  SUBMODULE_PATH: log-tutorials/tutorial-postgresql
silent: true # ëª…ë ¹ì–´ ì‹¤í–‰ ì‹œ ë¶ˆí•„ìš”í•œ ì¶œë ¥ ìµœì†Œí™”
tasks:
  ## ----------------------------------------------------
  ## ğŸŒ³ Subtree ê´€ë¦¬ ì‘ì—…
  ## ----------------------------------------------------

  # ëª¨ë“  Subtree ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì›ë³¸ì—ì„œ ê°€ì ¸ì™€ ì—…ë°ì´íŠ¸ (Subtree Pull)
  subtree-pull:
    desc: "Pull and merge changes from all remote Subtree repositories."
    cmds:
      - echo "Pulling changes from all Subtree remotes..."
      - for: {var: SUBTREES}
        cmd: git subtree pull --prefix={{.ITEM.path}} {{.ITEM.remote}} main --squash
      - echo "Subtree pull completed. Check git status for merge commits."
  # ëª¨ë“  Subtree í´ë”ì˜ ë³€ê²½ ì‚¬í•­ì„ ì›ê²© Subtree ë¦¬í¬ì§€í† ë¦¬ë¡œ í‘¸ì‹œ (Subtree Push)
  subtree-push:
    desc: "Push local changes from all Subtree folders back to their original remote repositories."
    cmds:
      - echo "Pushing changes to all Subtree remotes..."
      - for: {var: SUBTREES}
        cmd: git subtree push --prefix={{.ITEM.path}} {{.ITEM.remote}} main
      - echo "Subtree push completed."
  ## ----------------------------------------------------
  ## ğŸ“¦ Submodule ê´€ë¦¬ ì‘ì—…
  ## ----------------------------------------------------

  # ëª¨ë“  Submoduleì„ ì—…ë°ì´íŠ¸ (ìƒˆë¡œìš´ ì»¤ë°‹ SHAë¡œ ë™ê¸°í™”)
  submodule-update:
    desc: "Update all Submodules (e.g., tutorial-postgresql) to the latest commit."
    cmds:
      - 'echo "Updating Submodule: {{.SUBMODULE_PATH}}"'
      - 'git submodule update --remote --init --recursive {{.SUBMODULE_PATH}}'
      - 'echo "Submodule updated. Remember to commit the updated pointer in the main repo."'
  # íŠ¹ì • Submodule ë‚´ë¶€ë¡œ ì´ë™í•˜ì—¬ Git ì‘ì—… ìˆ˜í–‰ (ì˜ˆ: Submodule ìì²´ì— ì»¤ë°‹/í‘¸ì‹œ)
  submodule-push-self:
    desc: "Change directory into the Submodule and perform a standard push."
    cmds:
      - echo "Pushing changes from within {{.SUBMODULE_PATH}}..."
      - cd {{.SUBMODULE_PATH}}
      - git push origin main
      - cd - # ì´ì „ ë””ë ‰í† ë¦¬ë¡œ ë³µê·€
      - echo "Submodule internal push completed."
  ## ----------------------------------------------------
  ## ğŸš€ í†µí•© ê´€ë¦¬ ì‘ì—…
  ## ----------------------------------------------------

  # ë©”ì¸ ë¦¬í¬ì§€í† ë¦¬ì˜ ëª¨ë“  ì¢…ì†ì„±(Subtree/Submodule)ì„ ìµœì‹  ìƒíƒœë¡œ ì„¤ì •
  all-sync:
    desc: "Performs full sync: Pulls all Subtrees and updates all Submodules."
    cmds:
      # ì½œë¡  ëŒ€ì‹  í•˜ì´í”ˆìœ¼ë¡œ task ì°¸ì¡° ìˆ˜ì •
      - task: subtree-pull
      - task: submodule-update
      - echo "All dependencies synchronized. Commit the changes to the-nexus-codex."
